namespace GeneSort.Project

open System
open System.Threading

open FSharp.UMX

open GeneSort.Core
open GeneSort.Sorter
open GeneSort.Model.Sortable
open GeneSort.SortingOps
open GeneSort.Runs
open GeneSort.Db


module FullBoolEvals =

    let projectName = "FullBoolEvals" |> UMX.tag<projectName>
    let projectDesc = "FullBoolEvals on RandomSorters with SortingWidth from 4 to 16 generated by Msce, Mssi, Msrs, and Msuf"
    let sorterSetSourceProjectName = "RandomSorters4to64" |> UMX.tag<projectName>

    let randomType = rngType.Lcg
    let sortableDataType = sortableDataType.Bools


    let makeQueryParams 
            (repl: int<replNumber> option) 
            (sortingWidth:int<sortingWidth> option)
            (sorterModelType:sorterModelType option)
            (outputDataType: outputDataType) =
             
        queryParams.create(
            Some projectName,
            repl,
            outputDataType,
            [|
                (runParameters.sortingWidthKey, sortingWidth |> SortingWidth.toString); 
                (runParameters.sorterModelTypeKey, sorterModelType |> SorterModelType.toString);
            |])


    let makeQueryParamsFromRunParams
            (runParams: runParameters) 
            (outputDataType: outputDataType) =
        makeQueryParams
            (runParams.GetRepl())
            (runParams.GetSortingWidth())
            (runParams.GetSorterModelType())
            outputDataType

  
    let sortingWidthValues = 
        [4; 6; 8; 12; 16;] |> List.map(fun d -> d.ToString())

    let sortingWidths() : string*string list =
        (runParameters.sortingWidthKey, sortingWidthValues)
        
    let sorterModelKeyValues() : string list =
        [ Some sorterModelType.Mcse; 
          Some sorterModelType.Mssi;
          Some sorterModelType.Msrs; 
          Some sorterModelType.Msuf4; 
          Some sorterModelType.Msuf6; ]  |> List.map(SorterModelType.toString)

    let sorterModelKeys() : string*string list =
        (runParameters.sorterModelTypeKey, sorterModelKeyValues() )


    let paramMapFilter (runParameters: runParameters) = 
        let sorterModelKey = runParameters.GetSorterModelType().Value
        let sortingWidth = %runParameters.GetSortingWidth().Value
        let has3factor = (sortingWidth % 3 = 0)

        match sorterModelKey with
        | sorterModelType.Mcse -> Some runParameters
        | sorterModelType.Mssi -> Some runParameters
        | sorterModelType.Msrs -> Some runParameters
        | sorterModelType.Msuf4 ->
                if has3factor then None else
                Some runParameters
        | sorterModelType.Msuf6 -> 
                if has3factor then Some runParameters else
                None


    let paramMapRefiner (runParametersSeq: runParameters seq) : runParameters seq = 

        let enhancer (runParameters : runParameters) : runParameters =
            runParameters.SetRunFinished false
            runParameters.SetProjectName projectName
            runParameters


        seq {
            for runParameters in runParametersSeq do
                    let filtrate = paramMapFilter runParameters
                    if filtrate.IsSome then
                        let retVal = filtrate.Value |> enhancer
                        yield retVal
        }


    let parameterSpans = 
        [ sortingWidths(); sorterModelKeys();]

    let outputDataTypes = 
            [|
                outputDataType.RunParameters;
                outputDataType.SorterSetEval None;
                outputDataType.TextReport ("Bins" |> UMX.tag<textReportName>); 
                outputDataType.TextReport ("Profiles" |> UMX.tag<textReportName>); 
                outputDataType.TextReport ("Report3" |> UMX.tag<textReportName>); 
                outputDataType.TextReport ("Report4" |> UMX.tag<textReportName>);
            |]


    let project = 
            project.create 
                projectName 
                projectDesc
                parameterSpans
                outputDataTypes


    let executor
            (db: IGeneSortDb)
            (runParameters: runParameters) 
            (cts: CancellationTokenSource) 
            (progress: IProgress<string> option) : Async<unit> =

        async {
            let index = runParameters.GetId().Value  
            let repl = runParameters.GetRepl().Value
            let sortingWidth = runParameters.GetSortingWidth().Value
        
            match progress with
            | Some p -> p.Report(sprintf "Executing Run %s_%d  %s" %index %repl (runParameters.toString()))
            | None -> ()
        
            // Check cancellation before starting expensive operations
            cts.Token.ThrowIfCancellationRequested()

            let! allSourceRunParamsR = db.getAllProjectRunParametersAsync 
                                        sorterSetSourceProjectName 
                                        (Some cts.Token) 
                                        progress

            let allSourceRunParams = 
                match allSourceRunParamsR with
                | Ok rpA -> rpA
                | Error err -> failwith (sprintf "Error retrieving source run parameters from project %s: %s" 
                                                (sorterSetSourceProjectName |> UMX.untag<projectName>) err)

            let sourceRunParams =
                  RunParameters.pickByParameters 
                            allSourceRunParams 
                            [|runParameters.GetSorterModelKvp().Value; 
                              runParameters.GetReplKvp().Value; 
                              runParameters.GetSortingWidthKvp().Value |]
                  |> Option.defaultWith(fun () -> 
                        failwith (sprintf "No matching source run parameters found for Run %s_%d" %index %repl))


            // Load sorter set
            let queryParamsForSorterSet = makeQueryParamsFromRunParams runParameters (outputDataType.SorterSet None)
            let sorterSet = db.loadAsync queryParamsForSorterSet
                            |> Async.RunSynchronously
                            |> function
                                | Ok (outputData.SorterSet ss) -> ss
                                | Ok _ -> failwith "Unexpected output data type: expected SorterSet"
                                | Error err -> failwith (sprintf "Error loading SorterSet: %s" err)


            let sorterTestModel = msasF.create sortingWidth |> sortableTestModel.MsasF
            let sortableTests = SortableTestModel.makeSortableTests sorterTestModel sortableDataType
            let sorterSetEval = SorterSetEval.makeSorterSetEval sorterSet sortableTests

            cts.Token.ThrowIfCancellationRequested()
            match progress with
            | Some p -> p.Report(sprintf "Run %s_%d: Saving sorterSet test results" %index %repl)
            | None -> ()

            
            // Save sorterSetEval
            let queryParamsForSorterSetEval = makeQueryParamsFromRunParams runParameters (outputDataType.SorterSetEval None)
            do! db.saveAsync queryParamsForSorterSetEval (sorterSetEval |> outputData.SorterSetEval)

            // Mark run as finished
            runParameters.SetRunFinished true

    }


